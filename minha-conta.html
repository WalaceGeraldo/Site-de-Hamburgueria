<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Conta - The Burguer co.</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Oswald:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

    <header class="main-header">
        <div class="container">
            <h1 class="logo">The Burguer co.</h1>
            <button id="nav-toggle" aria-controls="primary-navigation" aria-expanded="false">Menu</button>
            <nav class="main-nav" id="primary-navigation">
                <ul>
                    <li><a href="index.html">In칤cio</a></li>
                    <li><a href="cardapio.html">Card치pio</a></li>
                    <li id="nav-cadastro"><a href="cadastro.html">Cadastro</a></li>
                    <li id="nav-login"><a href="login.html" class="btn-login">Login</a></li>
                    <li id="nav-account" style="display: none;"><a href="minha-conta.html">Minha Conta</a></li>
                    <li id="nav-user" style="display: none;"><a href="minha-conta.html" id="user-email" style="color: #d9a040; margin-right: 15px;"></a></li>
                    <li id="nav-logout" style="display: none;"><a href="#" id="logout-button" class="btn-logout">Sair</a></li>
                    <li id="nav-cart"><a href="cart.html" class="btn-cart"><img src="imagens/carrinho.png" alt="Carrinho" style="width: 24px; height: 24px; vertical-align: middle;margin-top: 5px;"></a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="account-section">
        <div class="container">
            <div class="account-hero">
                <div class="account-avatar">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                    </svg>
                </div>
                <div class="account-hero-info">
                    <h1 class="account-welcome" id="welcome">Carregando...</h1>
                    <p class="account-email-display" id="account-email">-</p>
                </div>
            </div>

            <div class="account-content-grid">
                <div class="account-sidebar">
                    <div class="account-card">
                        <h3>Navega칞칚o R치pida</h3>
                        <ul class="account-menu">
                            <li class="active"><a href="#pedidos">游닍 Meus Pedidos</a></li>
                            <li><a href="cardapio.html">游꼢 Fazer Novo Pedido</a></li>
                            <li><a href="cart.html">游 Ver Carrinho</a></li>
                        </ul>
                    </div>
                </div>

                <div class="account-main">
                    <div class="account-info" id="userInfo" style="display:none; background: #fdfdfd; border: 1px solid #eee; border-radius: 16px;">
                        <h2 style="font-size: 20px; font-family: 'Oswald', sans-serif; margin-bottom: 15px;">Detalhes da Conta</h2>
                        <p style="font-size: 16px; color: #555; margin: 10px 0;"><strong>Nome:</strong> <span id="userName">-</span></p>
                        <p style="font-size: 16px; color: #555; margin: 10px 0;"><strong>Email:</strong> <span id="userEmail">-</span></p>
                        <p style="font-size: 16px; color: #555; margin: 10px 0;"><strong>Membro desde:</strong> <span id="userCreated">-</span></p>
                    </div>

                    <div class="order-history" id="pedidos" style="margin-top: 30px;">
                        <div class="section-header">
                            <h2>Hist칩rico de Pedidos</h2>
                            <a href="cardapio.html" class="btn-new-order">+ Novo Pedido</a>
                        </div>
                        <div id="orders-list">
                            <p>Carregando pedidos...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="main-footer">
        <div class="container">
             <div class="footer-col footer-logo"><h3>THE BURGUER CO.</h3></div>
            <div class="footer-col"><h4>MAPA DO SITE</h4><ul><li><a href="index.html">IN칈CIO</a></li><li><a href="cardapio.html">CARD츼PIO</a></li><li><a href="cadastro.html">CADASTRO</a></li></ul></div>
            <div class="footer-col"><h4>SIGA-NOS NAS REDE SOCIAL</h4><div class="social-icons"><a href="#"><img src="imagens/icon-facebook.png" alt="Facebook"></a><a href="#"><img src="imagens/icon-instagram.png" alt="Instagram"></a><a href="#"><img src="imagens/icon-whatsapp.png" alt="WhatsApp"></a></div></div>
            <div class="footer-col"><h4>PEDIDO ONLINE</h4><ul><li><a href="#">IFOOD</a></li><li><a href="#">WHATSAPP</a></li><li><span>LIGAR: (21) 99999-9999</span></li></ul></div>
        </div>
    </footer>

    <script src="auth.js"></script>

    <script>
        // Verifica token em localStorage e consulta /api/me
        (async () => {
          // auth.js j치 cuidou do header, mas precisamos do token para o fetch
          const token = localStorage.getItem('authToken');
          if (!token) {
            // Se auth.js falhou (improv치vel), este 칠 um fallback
            window.location.href = 'login.html';
            return;
          }

          // --- CARREGAR DADOS DO USU츼RIO (/api/me) ---
          try {
            const res = await fetch('/api/me', {
              headers: { 'Authorization': 'Bearer ' + token }
            });
            const j = await res.json();
            if (!res.ok || !j.success) {
              // Token inv치lido, o auth.js j치 deve ter tratado, mas fazemos logout por seguran칞a
              window.doLogout(); 
              return;
            }

            // Mostrar dados do usu치rio
            const user = j.user;
            document.getElementById('welcome').textContent = `Ol치, ${user.name || user.email}!`;
            document.getElementById('account-email').textContent = user.email;
            document.getElementById('userName').textContent = user.name || '-';
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userCreated').textContent = new Date(user.created_at).toLocaleDateString('pt-BR');
            document.getElementById('userInfo').style.display = 'block';
            
          } catch (e) {
            console.error('Erro ao verificar token:', e);
            window.doLogout(); // Se a API falhar, desloga
          }
        })();

        // --- CARREGAR PEDIDOS (/api/orders) ---
        (async function loadOrders(){
          const token = localStorage.getItem('authToken');
          const target = document.getElementById('orders-list');
          if (!token) { target.innerHTML = '<em>Fa칞a login para ver seus pedidos.</em>'; return; }
          
          try{
            const res = await fetch('/api/orders', { headers: { 'Authorization': 'Bearer '+token } });
            const j = await res.json();
            if (!res.ok || !j.success) { target.innerHTML = '<em>N칚o foi poss칤vel carregar pedidos.</em>'; return; }
            if (!j.orders || !j.orders.length) { 
              target.innerHTML = `
                <div class="no-orders-message" style="display:flex; flex-direction: column; align-items: center; padding: 40px 0;">
                    <span class="no-orders-icon" style="font-size: 64px; opacity: 0.5;">游늶</span>
                    <span>Voc칡 ainda n칚o fez nenhum pedido.</span>
                </div>`; 
              return; 
            }

            // Renderizar os cards de pedido (usando o estilo do seu CSS)
            target.innerHTML = ''; // Limpa o "Carregando..."
            
            j.orders.forEach(order => {
              const card = document.createElement('div');
              card.className = 'order-card';

              const itemsHTML = order.items.map(it => 
                `<div class="order-item-info" style="display:flex; justify-content: space-between; font-size: 15px; color: #333; padding: 4px 0;">
                   <span class="order-item-name">${it.qty}x ${it.name}</span>
                   <span>R$ ${(it.price * it.qty).toFixed(2)}</span>
                 </div>`
              ).join('');

              const address = order.address || {};
              const addressHTML = `
                <p class="order-payment" style="font-size: 14px; color: #555; margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee;">
                  <strong>Endere칞o:</strong> ${address.street || 'N/A'}, ${address.number || 'N/A'} - ${address.neighborhood || 'N/A'}
                </p>`;
                
              const paymentMap = {'pix': 'PIX', 'card': 'Cart칚o', 'cash': 'Dinheiro'};
              const paymentText = paymentMap[order.paymentMethod] || order.paymentMethod;

              card.innerHTML = `
                <div class="order-header">
                  <div>
                    <h3>Pedido #${order.id}</h3>
                    <p class="order-date">${new Date(order.created_at).toLocaleString('pt-BR')}</p>
                  </div>
                  <span class="status-badge pending">Pendente</span>
                </div>
                <div class="order-items" style="margin-bottom: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                  ${itemsHTML}
                </div>
                ${addressHTML}
                <div class="order-footer">
                  <p class="order-payment">
                    <strong>Pagamento:</strong> ${paymentText}
                  </p>
                  <p class="order-total" style="text-align: right;">
                    Total: <strong>R$ ${Number(order.total).toFixed(2)}</strong>
                  </p>
                </div>
              `;
              target.appendChild(card);
            });

          }catch(e){ 
            console.error("Erro ao carregar pedidos:", e);
            target.innerHTML = '<em>Erro ao carregar pedidos.</em>'; 
          }
        })();
        
        // --- ATUALIZAR CONTADOR DO CARRINHO ---
        (function(){
            function updateCart(){
                try{ const cart = JSON.parse(localStorage.getItem('site_cart_v1')||'[]'); const count = cart.reduce((s,i)=>s+(i.qty||0),0); const el = document.getElementById('cart-count'); if(el) el.textContent = count; }catch(e){}
            }
            updateCart();
            window.addEventListener('storage', updateCart);
            document.addEventListener('DOMContentLoaded', updateCart);
        })();

        // --- MENU MOBILE ---
        document.addEventListener('DOMContentLoaded', () => {
            const navToggle = document.getElementById('nav-toggle');
            const primaryNav = document.getElementById('primary-navigation');
            if (navToggle && primaryNav) {
                navToggle.addEventListener('click', () => {
                    const expanded = navToggle.getAttribute('aria-expanded') === 'true' || false;
                    navToggle.setAttribute('aria-expanded', !expanded);
                    primaryNav.classList.toggle('open');
                });
            }
        });
    </script>
</body>
</html>